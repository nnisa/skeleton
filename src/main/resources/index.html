<!DOCTYPE html>
<html>
<head>
    <script data-require="jquery@*" data-semver="3.1.1" src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">

    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>

    <style>
        #input_section { 
            display: none; 
        }
        #add-receipt { 
            cursor:pointer; 
        }
        div#add_receipt_section {
        width: 100%;
        height: 70px;
        }
        /*#container {border: 1px solid brown;}*/
        H1 {float: left;}
        .button{
            background-color:#55A;
            /*border: 1px solid #229;*/
            width: 100px;
            float: right;
            font-size: 2em;
            color: white;
            text-align: center;
        }
        #receiptList {
            /*border: 1px solid green;*/
            clear: both;
        }
        .receipt {
            background-color: #eee;
            margin-bottom: 5px;
        }
        #input_section{
            display: none;
        }
    </style>
</head>

<body>
<DIV id="container">
    <div id="section">
        <div id="add_receipt_section">
            <h1>My receipts</h1>
            <!--     <div class="button">+</div> -->
            <button id = "add-receipt" class="w3-btn w3-blue tag_button button">+</button>
        </div>
        <div id="add_receipt_form">
            <div id="input_section">
                <p>
                <label>Merchant</label>
                <input id= "merchant" class="w3-input" type="text"></p>
                <p><label>Amount</label>
                <input id= "amount" class="w3-input" type=number></p>
                <button onclick="post_cancel_button()" id = "cancel-receipt" class="w3-btn w3-blue cancel_button">CANCEL</button>
                <button onclick="post_save_button()" id = "save-receipt" class="w3-btn w3-blue save_button">SAVE</button>
            </div>
        </div>
        <div id="receiptList">
                <div class="row">
                  <div class="col time"><h3>Time</h3></div>
                  <div class="col merchant"><h3>Merchant</h3></div>
                  <div class="col amount"><h3>$</h3></div>
                  <div class="col tags"><h3>Tags</h3></div>
                </div>
        </div>
    </div>


</DIV>

<script type="text/javascript">
    $('#add-receipt').click(function(e){
        $('#input_section').toggle();
    });

        // This is the idiomatic way to ensure that JQuery does not
        // execute until the page has loaded
        // const api = "http://0.0.0.0:8080"; 
        const api = ""; 
        $(function table(){
            // <- do not need a root api URL if this page is served directly by the API
            $.getJSON(api+"/receipts", function(receipts){
                console.log(receipts);

                for(var i=0; i < receipts.length; i++) {
                    var receipt = receipts[i];
                    $(`<div id =${receipt.id} class="row receipt">` +
                        `<div class="col time">${receipt.created}</div>` +
                        `<div class="col merchant">${receipt.merchant}</div>` +
                        `<div class="col amount">${receipt.amount}</div>` +
                        `<div class ="col tags" id="tag_section">` +
                            `<button onclick="receipt_tag_button(this)" class="w3-btn w3-blue tag_button add-tag">Add</button>` +
                        `</div>` +
                      `</div>`)
                        .appendTo($("#receiptList"));

                    var tagLength =  receipts[i].tags.length;
                    if (tagLength > 0){
                        for(var j=0; j <tagLength; j++){

                            $(`<button onclick="added_tag_button(this)" class="w3-btn w3-blue tagValue added_tag_button">${receipts[i].tags[j]}</button><br>`).prependTo($(`#${receipt.id} > #tag_section`));
                            

                        }
                    }
                }
            })
        })

    function post_save_button(merchant, amount) {
        merchant = document.getElementById('merchant').value
        amount = document.getElementById('amount').value
        var stringData = { "merchant": merchant,  "amount": amount };
        console.log(stringData)

        $.ajax({
          type: "POST",
          url: api+"/receipts",
          method: "POST",
          data: JSON.stringify(stringData),
          dataType: "json",
          contentType: "application/json; charset=utf-8"
        }).done(function(data) {
            $("#merchant").val("");
            $("#amount").val("");
            $('#input_section').toggle();
            $.getJSON(api+"/receipts", function(receipts){
                var i =  receipts.length-1
                var receipt = receipts[i];
                $(`<div id =${receipt.id} class="row receipt"><div class="col time">${receipt.created}</div><div class="col merchant">${receipt.merchant}</div><div class="col amount">${receipt.amount}</div><div class ="col tags" id="tag_section"><button onclick="receipt_tag_button(this)" class="w3-btn w3-blue tag_button tagValue add-tag">Add</button></div></div>`)
                        .appendTo($("#receiptList"));
            })
        });
    }

    function post_cancel_button() {
        $("#merchant").val("");
        $("#amount").val("");
        $('#input_section').hide();

    }

    function receipt_tag_button(button) {
        var tag_section = $(button).parent();
        var id = $(button).parent().parent().attr('id');
        console.log(id)
        input_template = $('<input id= "add_tag_input" class="w3-input tag_input" type="text">');
        input_template.appendTo(tag_section);
        
        $('#add_tag_input').keypress(function (e) {
            if (e.which == 13) {
                tagValue = document.getElementById('add_tag_input').value;
                $(`<button onclick="added_tag_button(this)" class="w3-btn w3-blue added_tag_button tagValue">${tagValue}</button>`).appendTo($(`#${id} > #tag_section`));
                $.ajax({
                  type: "PUT",
                  url: api+"/tags/"+tagValue,
                  data: JSON.stringify(id),
                  contentType: "application/json; charset=utf-8",
                  success: function(result){
                    console.log("hello")
                    console.log($("#add_tag_input"))
                    $("#add_tag_input").val("");
                    $("#add_tag_input").remove();
                  }
                }).done(function(data) {
            });            
            
            return false;
          }
        });
    }

    //click on an added tag 
    function added_tag_button(button){
        var tagValue = $(button).text();
        var id = $(button).parent().parent().attr('id');
        $.ajax({
          type: "PUT",
          url: api+"/tags/"+tagValue,
          data: JSON.stringify(id),
          contentType: "application/json; charset=utf-8",
          success: function(result){
            $(button).remove();
          }
        }).done(function(data) {
    });  

    }


</script>
</body>
</html>



    












